<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Споредба на цени | Македонски маркети</title>
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
        
        // Check user's preferred color scheme
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #5D5CDE;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dark .loader {
            border-color: rgba(30, 30, 30, 0.3);
            border-top-color: #5D5CDE;
        }
        
        .banner-gradient {
            background: linear-gradient(90deg, #4c4bd4 0%, #5D5CDE 100%);
        }

        /* Hide scrollbar but allow scrolling */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Animation for fade-in effect */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        /* Price comparison chart container */
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        /* Store color classes */
        .store-color-KAM {
            background-color: rgba(34, 197, 94, 0.2);
            color: rgb(22, 101, 52);
        }
        
        .dark .store-color-KAM {
            background-color: rgba(34, 197, 94, 0.3);
            color: rgb(134, 239, 172);
        }
        
        .store-color-Tinex {
            background-color: rgba(59, 130, 246, 0.2);
            color: rgb(30, 64, 175);
        }
        
        .dark .store-color-Tinex {
            background-color: rgba(59, 130, 246, 0.3);
            color: rgb(147, 197, 253);
        }
        
        .store-color-Vero {
            background-color: rgba(239, 68, 68, 0.2);
            color: rgb(153, 27, 27);
        }
        
        .dark .store-color-Vero {
            background-color: rgba(239, 68, 68, 0.3);
            color: rgb(252, 165, 165);
        }
        
        .store-color-Stokomak {
            background-color: rgba(234, 179, 8, 0.2);
            color: rgb(133, 77, 14);
        }
        
        .dark .store-color-Stokomak {
            background-color: rgba(234, 179, 8, 0.3);
            color: rgb(253, 224, 71);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="banner-gradient text-white shadow-md">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <h1 class="text-2xl font-bold">Споредба на цени</h1>
                </div>
                <div class="flex items-center">
                    <button id="toggleDarkMode" class="p-2 rounded-full hover:bg-white/10 ml-2" title="Toggle dark mode">
                        <i class="bx bx-moon text-xl dark:hidden"></i>
                        <i class="bx bx-sun text-xl hidden dark:inline"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 flex-grow">
        <!-- Welcome Screen - Initially Visible -->
        <div id="welcome-screen" class="py-8">
            <div class="max-w-3xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4 text-primary">Добредојдовте во апликацијата за споредба на цени</h2>
                <p class="mb-4">Оваа апликација ви овозможува да ги споредите цените на производите од различни супермаркети во Македонија и да ги најдете најдобрите зделки.</p>
                
                <h3 class="text-xl font-semibold mb-2 mt-6">Како да користите:</h3>
                <ol class="list-decimal pl-5 space-y-2 mb-6">
                    <li>Изберете датум за споредба од паѓачкото мени</li>
                    <li>Пребарајте конкретен производ или прегледајте ги сите достапни</li>
                    <li>Филтрирајте по бренд или маркет</li>
                    <li>Споредете ги цените меѓу различни маркети</li>
                </ol>

                <h3 class="text-xl font-semibold mb-2">Вклучени супермаркети:</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex items-center">
                        <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                        <span class="font-medium">Веро</span>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex items-center">
                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                        <span class="font-medium">Тинекс</span>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex items-center">
                        <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                        <span class="font-medium">КАМ Маркет</span>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex items-center">
                        <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                        <span class="font-medium">Стокомак</span>
                    </div>
                </div>

                <div class="flex justify-center">
                    <button id="start-button" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-md">
                        Започни со споредба
                    </button>
                </div>
            </div>

            <!-- Date selection -->
            <div class="max-w-3xl mx-auto mb-8">
                <h3 class="text-xl font-semibold mb-4">Изберете датум за споредба:</h3>
                <div class="relative">
                    <select id="date-selector" class="block w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg py-3 px-4 mb-4 appearance-none focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Вчитување на датуми...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                        <i class="bx bx-chevron-down text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Screen - Initially Hidden -->
        <div id="results-screen" class="hidden">
            <!-- Back button -->
            <button id="back-button" class="flex items-center mb-6 text-primary hover:underline">
                <i class="bx bx-arrow-back mr-1"></i> Назад кон почетна
            </button>
            
            <!-- Filters Section -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="date-filter" class="block text-sm font-medium mb-2">Датум:</label>
                        <div class="relative">
                            <select id="date-filter" class="block w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 appearance-none text-base">
                                <!-- Will be populated dynamically -->
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class="bx bx-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="brand-filter" class="block text-sm font-medium mb-2">Бренд:</label>
                        <div class="relative">
                            <select id="brand-filter" class="block w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 appearance-none text-base">
                                <option value="all">Сите брендови</option>
                                <option value="KAM">КАМ</option>
                                <option value="Tinex">Тинекс</option>
                                <option value="Vero">Веро</option>
                                <option value="Stokomak">Стокомак</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class="bx bx-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="market-filter" class="block text-sm font-medium mb-2">Маркет:</label>
                        <div class="relative">
                            <select id="market-filter" class="block w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 appearance-none text-base">
                                <option value="all">Сите маркети</option>
                                <!-- Will be populated dynamically -->
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class="bx bx-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row md:items-end gap-4">
                    <div class="flex-grow">
                        <label for="search-input" class="block text-sm font-medium mb-2">Пребарај продукт:</label>
                        <div class="relative">
                            <input type="text" id="search-input" class="block w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 pl-10 text-base" placeholder="Внесете име на продукт...">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="bx bx-search text-gray-500"></i>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="search-button" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            <i class="bx bx-search mr-1"></i> Пребарај
                        </button>
                        <button id="toggle-view" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 font-medium py-2 px-4 rounded-lg transition-colors">
                            <i class="bx bx-grid-alt mr-1 view-grid-icon"></i>
                            <i class="bx bx-list-ul mr-1 view-list-icon hidden"></i>
                            <span class="view-text">Картички</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Price Comparison Chart (Initially Hidden) -->
            <div id="price-chart-container" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6 hidden">
                <h3 class="text-lg font-semibold mb-4">Споредба на цени</h3>
                <div class="chart-container">
                    <canvas id="price-chart"></canvas>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="flex justify-center items-center py-12">
                <div class="loader mr-3"></div>
                <p>Ги вчитуваме најновите цени...</p>
            </div>

            <!-- Results List -->
            <div id="results-container">
                <!-- Table View (Initially Hidden) -->
                <div id="table-view" class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6 hidden">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Листа на продукти (<span id="product-count">0</span>)</h3>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                Датум: <span id="current-date" class="font-medium"></span>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Продукт</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Единица</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Цена</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Маркет</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Бренд</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Table rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Card View -->
                <div id="card-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Product cards will be dynamically generated here -->
                </div>
            </div>

            <!-- No Results Message -->
            <div id="no-results" class="hidden text-center py-12 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-xl font-semibold mb-2">Нема пронајдени производи</h3>
                <p class="text-gray-500 dark:text-gray-400">Обидете се со други клучни зборови или филтри</p>
            </div>
            
            <!-- Pagination controls -->
            <div id="pagination" class="flex justify-center my-6 hidden">
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <button id="prev-page" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-primary focus:z-10 focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="bx bx-chevron-left"></i>
                    </button>
                    <div id="page-numbers" class="flex">
                        <!-- Page buttons will be added here -->
                    </div>
                    <button id="next-page" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-md hover:bg-gray-100 hover:text-primary focus:z-10 focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="bx bx-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden max-w-3xl mx-auto bg-red-100 dark:bg-red-900 border-l-4 border-red-500 text-red-700 dark:text-red-200 p-4 mb-6 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p id="error-text" class="text-sm md:text-base">
                        Настана грешка при вчитувањето на податоците.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 dark:bg-gray-800 py-6 mt-auto">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-sm text-gray-600 dark:text-gray-400"></p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="https://github.com/nestorovski/daily-cache-ceni" target="_blank" class="text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                    </a>
                    <p id="lastUpdated" class="text-sm text-gray-600 dark:text-gray-400">
                        Последно ажурирање: <span id="update-date">-</span>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast notifications container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

    <script>
        // Global variables
        let allData = [];
        let markets = [];
        let selectedDate = '';
        let availableDates = [];
        let priceChart = null;
        let currentPage = 1;
        let itemsPerPage = 16;
        let currentView = 'card'; // 'card' or 'table'
        
        // DOM elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startButton = document.getElementById('start-button');
        const backButton = document.getElementById('back-button');
        const dateSelector = document.getElementById('date-selector');
        const dateFilter = document.getElementById('date-filter');
        const brandFilter = document.getElementById('brand-filter');
        const marketFilter = document.getElementById('market-filter');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noResults = document.getElementById('no-results');
        const tableView = document.getElementById('table-view');
        const tableBody = document.getElementById('table-body');
        const cardView = document.getElementById('card-view');
        const toggleViewButton = document.getElementById('toggle-view');
        const toggleDarkModeButton = document.getElementById('toggleDarkMode');
        const productCount = document.getElementById('product-count');
        const currentDateDisplay = document.getElementById('current-date');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const pagination = document.getElementById('pagination');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
        const pageNumbers = document.getElementById('page-numbers');
        const updateDateDisplay = document.getElementById('update-date');
        
        // Function to show toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'p-4 mb-4 rounded-lg shadow-lg flex items-center max-w-xs animate-fade-in';
            
            // Set background and icon based on type
            let bgColor, icon;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    icon = 'bx-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    icon = 'bx-error-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    icon = 'bx-error';
                    break;
                default:
                    bgColor = 'bg-blue-500';
                    icon = 'bx-info-circle';
            }
            
            toast.classList.add(bgColor, 'text-white');
            toast.innerHTML = `
                <i class="bx ${icon} mr-2 text-xl"></i>
                <span class="flex-grow">${message}</span>
                <button class="ml-2 focus:outline-none" onclick="this.parentElement.remove()">
                    <i class="bx bx-x"></i>
                </button>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // Function to format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('mk-MK', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                console.error('Error formatting date:', e);
                return dateString;
            }
        }
        
        // Function to toggle dark mode
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            
            // Update chart if it exists
            if (priceChart) {
                const isDark = document.documentElement.classList.contains('dark');
                priceChart.options.scales.x.grid.color = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                priceChart.options.scales.y.grid.color = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                priceChart.options.scales.x.ticks.color = isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
                priceChart.options.scales.y.ticks.color = isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
                priceChart.update();
            }
        }
        
        // Function to toggle view between card and table
        function toggleView() {
            currentView = currentView === 'card' ? 'table' : 'card';
            
            const viewText = document.querySelector('.view-text');
            const gridIcon = document.querySelector('.view-grid-icon');
            const listIcon = document.querySelector('.view-list-icon');
            
            if (currentView === 'card') {
                cardView.classList.remove('hidden');
                tableView.classList.add('hidden');
                viewText.textContent = 'Картички';
                gridIcon.classList.remove('hidden');
                listIcon.classList.add('hidden');
            } else {
                cardView.classList.add('hidden');
                tableView.classList.remove('hidden');
                viewText.textContent = 'Табела';
                gridIcon.classList.add('hidden');
                listIcon.classList.remove('hidden');
            }
        }
        
        // Function to fetch available dates
        async function fetchAvailableDates() {
            try {
                // Array of paths to try for GitHub Pages and local development
                const pathsToTry = [
                    'cache/',
                    '../cache/',
                    '/daily-cache-ceni/cache/',
                    'daily-cache-ceni/cache/'
                ];
                
                let success = false;
                
                for (const path of pathsToTry) {
                    try {
                        console.log(`Trying to fetch dates from: ${path}`);
                        const response = await fetch(path);
                        
                        if (!response.ok) continue;
                        
                        const text = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(text, 'text/html');
                        
                        const links = doc.querySelectorAll('a');
                        
                        // Find JSON files with date format
                        const dateRegex = /^\d{4}-\d{2}-\d{2}\.json$/;
                        availableDates = Array.from(links)
                            .map(link => link.getAttribute('href'))
                            .filter(href => dateRegex.test(href))
                            .map(href => href.replace('.json', ''))
                            .sort()
                            .reverse(); // Most recent first
                        
                        if (availableDates.length > 0) {
                            console.log(`Successfully found dates in ${path}`);
                            success = true;
                            // Remember successful path for later use
                            window.successfulCachePath = path;
                            break;
                        }
                    } catch (e) {
                        console.warn(`Error checking path ${path}:`, e);
                    }
                }
                
                if (!success) {
                    throw new Error('Could not find date listings in any path');
                }
                
                populateDateSelectors(availableDates);
                
                if (availableDates.length > 0) {
                    selectedDate = availableDates[0];
                    dateSelector.value = selectedDate;
                    dateFilter.value = selectedDate;
                    currentDateDisplay.textContent = formatDate(selectedDate);
                    updateDateDisplay.textContent = formatDate(selectedDate);
                } else {
                    showError('Нема податоци во кеш директориумот.');
                }
            } catch (error) {
                console.error('Error fetching dates:', error);
                showError('Грешка при вчитување на датуми: ' + error.message);
            }
        }
        
        // Function to populate date selectors
        function populateDateSelectors(dates) {
            dateSelector.innerHTML = '';
            dateFilter.innerHTML = '';
            
            dates.forEach(date => {
                // Add to welcome screen selector
                const option1 = document.createElement('option');
                option1.value = date;
                option1.textContent = formatDate(date);
                dateSelector.appendChild(option1);
                
                // Add to filter selector
                const option2 = document.createElement('option');
                option2.value = date;
                option2.textContent = formatDate(date);
                dateFilter.appendChild(option2);
            });
        }
        
        // Function to fetch data for selected date
        async function fetchDataForDate(date) {
            showLoading();
            
            try {
                // Try different paths to find the data
                let data = null;
                let errorMsg = '';
                
                const paths = [
                    `cache/${date}.json`,
                    `../cache/${date}.json`,
                    `daily-cache-ceni/cache/${date}.json`
                ];
                
                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            data = await response.json();
                            break;
                        } else {
                            errorMsg += `Failed to fetch from ${path}: ${response.status} ${response.statusText}\n`;
                        }
                    } catch (e) {
                        errorMsg += `Error fetching ${path}: ${e.message}\n`;
                    }
                }
                
                if (!data) {
                    throw new Error('Failed to fetch data from any path: ' + errorMsg);
                }
                
                allData = data;
                
                // Extract unique markets
                markets = [...new Set(data.map(item => item.market_name))].sort();
                
                // Populate market filter
                populateMarketFilter(markets);
                
                // Apply filters and display data
                filterAndDisplayData();
                
                // Hide loading indicator
                hideLoading();
            } catch (error) {
                console.error('Error fetching data:', error);
                showError('Грешка при вчитување на податоци: ' + error.message);
            }
        }
        
        // Function to populate market filter
        function populateMarketFilter(marketList) {
            marketFilter.innerHTML = '<option value="all">Сите маркети</option>';
            
            marketList.forEach(market => {
                const option = document.createElement('option');
                option.value = market;
                option.textContent = market;
                marketFilter.appendChild(option);
            });
        }
        
        // Function to filter and display data
        function filterAndDisplayData() {
            const brandValue = brandFilter.value;
            const marketValue = marketFilter.value;
            const searchValue = searchInput.value.trim().toLowerCase();
            
            let filteredData = [...allData];
            
            // Apply brand filter
            if (brandValue !== 'all') {
                filteredData = filteredData.filter(item => item.brand === brandValue);
            }
            
            // Apply market filter
            if (marketValue !== 'all') {
                filteredData = filteredData.filter(item => item.market_name === marketValue);
            }
            
            // Apply search filter
            if (searchValue) {
                filteredData = filteredData.filter(item => 
                    item.name.toLowerCase().includes(searchValue)
                );
            }
            
            // Reset pagination
            currentPage = 1;
            
            // Display the filtered data
            displayData(filteredData);
        }
        
        // Function to show loading indicator
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            tableView.classList.add('hidden');
            cardView.innerHTML = '';
            noResults.classList.add('hidden');
            pagination.classList.add('hidden');
        }
        
        // Function to hide loading indicator
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }
        
        // Function to show error message
        function showError(message) {
            hideLoading();
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            tableView.classList.add('hidden');
            cardView.innerHTML = '';
            noResults.classList.add('hidden');
            pagination.classList.add('hidden');
        }
        
        // Function to update pagination controls
        function updatePagination(totalItems) {
            if (totalItems <= itemsPerPage) {
                pagination.classList.add('hidden');
                return;
            }
            
            pagination.classList.remove('hidden');
            
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // Enable/disable prev/next buttons
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage === totalPages;
            
            // Generate page numbers
            pageNumbers.innerHTML = '';
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Add first page if not visible
            if (startPage > 1) {
                addPageButton(1);
                if (startPage > 2) {
                    addEllipsis();
                }
            }
            
            // Add page numbers
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i);
            }
            
            // Add last page if not visible
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    addEllipsis();
                }
                addPageButton(totalPages);
            }
            
            // Helper functions
            function addPageButton(pageNum) {
                const btn = document.createElement('button');
                btn.textContent = pageNum;
                btn.className = 'px-4 py-2 text-sm font-medium border border-gray-200 dark:border-gray-600 ' + 
                                (pageNum === currentPage 
                                    ? 'bg-primary text-white' 
                                    : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-600');
                
                btn.addEventListener('click', () => {
                    if (currentPage !== pageNum) {
                        currentPage = pageNum;
                        displayData(getFilteredData());
                    }
                });
                
                pageNumbers.appendChild(btn);
            }
            
            function addEllipsis() {
                const span = document.createElement('span');
                span.textContent = '...';
                span.className = 'px-4 py-2 text-sm font-medium border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white';
                pageNumbers.appendChild(span);
            }
        }
        
        // Function to get current filtered data
        function getFilteredData() {
            const brandValue = brandFilter.value;
            const marketValue = marketFilter.value;
            const searchValue = searchInput.value.trim().toLowerCase();
            
            let filteredData = [...allData];
            
            // Apply brand filter
            if (brandValue !== 'all') {
                filteredData = filteredData.filter(item => item.brand === brandValue);
            }
            
            // Apply market filter
            if (marketValue !== 'all') {
                filteredData = filteredData.filter(item => item.market_name === marketValue);
            }
            
            // Apply search filter
            if (searchValue) {
                filteredData = filteredData.filter(item => 
                    item.name.toLowerCase().includes(searchValue)
                );
            }
            
            return filteredData;
        }
        
        // Function to display data
        function displayData(data) {
            // Update product count
            productCount.textContent = data.length;
            
            if (data.length === 0) {
                hideLoading();
                noResults.classList.remove('hidden');
                tableView.classList.add('hidden');
                cardView.innerHTML = '';
                pagination.classList.add('hidden');
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, data.length);
            const paginatedData = data.slice(startIndex, endIndex);
            
            updatePagination(data.length);
            
            // Hide no results and error messages
            noResults.classList.add('hidden');
            errorMessage.classList.add('hidden');
            
            // Display in current view mode
            if (currentView === 'table') {
                displayTableData(paginatedData);
                tableView.classList.remove('hidden');
                cardView.innerHTML = '';
            } else {
                displayCardData(paginatedData);
                tableView.classList.add('hidden');
            }
        }
        
        // Function to display data in table view
        function displayTableData(data) {
            tableBody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                
                // Apply stripe effect
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">${item.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">${item.unit || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium">${item.price} ден.</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded store-color-${item.brand}">
                            ${item.market_name}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">${item.brand}</div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Function to display data in card view
        function displayCardData(data) {
            cardView.innerHTML = '';
            
            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition duration-200 fade-in';
                
                card.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between mb-3">
                            <span class="px-2 py-1 text-xs font-medium rounded store-color-${item.brand}">
                                ${item.market_name}
                            </span>
                            <span class="text-sm text-gray-500 dark:text-gray-400">${item.brand}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-2 line-clamp-2 h-14">${item.name}</h3>
                        <div class="flex justify-between items-end mt-4">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${item.unit || ''}</p>
                                <div class="text-xl font-bold mt-1">${item.price} <span class="text-sm">ден.</span></div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500 dark:text-gray-400">${formatDate(selectedDate)}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                cardView.appendChild(card);
            });
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch available dates
            fetchAvailableDates();
            
            // Event listener for start button
            startButton.addEventListener('click', function() {
                if (selectedDate) {
                    welcomeScreen.classList.add('hidden');
                    resultsScreen.classList.remove('hidden');
                    fetchDataForDate(selectedDate);
                } else {
                    showToast('Изберете датум за да продолжите', 'warning');
                }
            });
            
            // Event listener for date selector on welcome screen
            dateSelector.addEventListener('change', function() {
                selectedDate = this.value;
            });
            
            // Event listener for date filter in results screen
            dateFilter.addEventListener('change', function() {
                selectedDate = this.value;
                currentDateDisplay.textContent = formatDate(selectedDate);
                updateDateDisplay.textContent = formatDate(selectedDate);
                fetchDataForDate(selectedDate);
            });
            
            // Event listeners for filters
            brandFilter.addEventListener('change', filterAndDisplayData);
            marketFilter.addEventListener('change', filterAndDisplayData);
            
            // Event listener for search
            searchButton.addEventListener('click', filterAndDisplayData);
            searchInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    filterAndDisplayData();
                }
            });
            
            // Event listener for toggle view
            toggleViewButton.addEventListener('click', toggleView);
            
            // Event listener for toggle dark mode
            toggleDarkModeButton.addEventListener('click', toggleDarkMode);
            
            // Event listener for back button
            backButton.addEventListener('click', function() {
                resultsScreen.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
            });
            
            // Event listeners for pagination
            prevPageButton.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    displayData(getFilteredData());
                }
            });
            
            nextPageButton.addEventListener('click', function() {
                const filteredData = getFilteredData();
                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                
                if (currentPage < totalPages) {
                    currentPage++;
                    displayData(filteredData);
                }
            });
        });
    </script>
</body>
</html>
